import h from"deepmerge";import{JSONPath as M}from"jsonpath-plus";var S={objectMergeMode:"overwrite",arrayMergeMode:"replace"},j=(e,a)=>[...Array(a-e)].map((n,t)=>e+t),d=(e,a)=>a,x=(e,a)=>e;function O(e){return e.startsWith("`")?e.substring(1):e}function V(e){return e.startsWith("$.")}function A(e){return!!e&&typeof e=="object"&&"@path"in e&&typeof e["@path"]=="string"}function I(e){return!!e&&typeof e=="object"&&"@element"in e&&!!e["@element"]&&typeof e["@element"]=="object"}function g(e,a,n,t){let r=n;if(A(n)){if(r=g(e,a,n["@path"],t),n["@default"]!==void 0&&(r=r!=null?r:f(e,a,n["@default"],t)),n["@transform"]){let i={source:e,schema:n["@path"]};r=n["@transform"](r,a,i)}}else if(typeof n=="string")if(V(n)){let i=!0,c=n;n.endsWith("[]")&&(c=n.substring(0,n.length-2),i=!1);let l=M({path:c,json:e});i&&Array.isArray(l)&&l.length<=1?r=l[0]:r=l}else r=O(n);return r}function w(e,a,n,t){let r=a;(!r||typeof r!="object")&&(r={});let i=Object.fromEntries(Object.entries(n).map(([b,y])=>{let J=O(b);return[J,f(e,r[J],y,t)]})),c;switch(t.arrayMergeMode){case"replace":c=d;break;case"append":case"prepend":switch(t.objectMergeMode){case"overwrite":c=d;break;case"preserve":c=x;break}break}let l=r;switch(t.objectMergeMode){case"overwrite":l=h(r,i,{arrayMerge:c});break;case"preserve":l=h(i,r,{arrayMerge:c});break;case"replace":l=i;break}return l}function v(e,a,n,t){let r=a;Array.isArray(a)||(r=[]);let i=n.flatMap((l,b)=>{if(I(l)){let y={};for(let[o,u]of Object.entries(l["@element"])){let s=u==null?void 0:u["@padding"],p=f(e,r[b],u,t);y[o]=[p,s]}let J=Math.max(...Object.values(y).map(([o])=>Array.isArray(o)?o.length:1));if(l["@length"]){let o=f(e,null,l["@length"],t);Number.isInteger(o)&&(J=o),Array.isArray(o)&&(J=o.length)}return j(0,J).map(o=>Object.fromEntries(Object.entries(y).map(([u,[s,p]])=>{var m;if(Array.isArray(s))switch(p!=null?p:"empty"){case"empty":return[u,s[o]];case"edge":return[u,(m=s[o])!=null?m:s.at(-1)];case"reflect":return[u,s[(o/s.length|0)%2===0?o%s.length:s.length-1-o%s.length]];case"wrap":return[u,s[o%s.length]]}switch(p!=null?p:"edge"){case"empty":return[u,o===0?s:void 0];default:return[u,s]}}).filter(([u,s])=>s!==void 0)))}return[f(e,r[b],l,t)]}),c=r;switch(t.arrayMergeMode){case"replace":c=i;break;case"append":c=[...r,...i];break;case"prepend":c=[...i,...r];break}return c}function f(e,a,n,t){return Array.isArray(n)?v(e,a,n,t):n!=null&&typeof n=="object"&&!A(n)?w(e,a,n,t):g(e,a,n,t)}function P(e,a,n=null,t){let r=Object.assign({},S,t!=null?t:{});return f(e,n,a,r)}function T(e,a){return g(e,null,a,S)}export{P as map,T as value};
